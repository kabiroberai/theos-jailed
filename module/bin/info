#!/bin/bash

source "$SETUP_ENVIRONMENT" "Generating info for `basename "$IPA"`"

codesign -d --entitlements - "$APPDIR/$APP_BINARY" > "$ENTITLEMENTS" 2>/dev/null
if [ "$?" != "0" ]; then
	error "Failed to get entitlements for $APPDIR/$APP_BINARY"
fi

for ENT in `grep -a '<key>' "$ENTITLEMENTS"`; do
	ENTITLEMENT=`echo $ENT | cut -f2 -d\> | cut -f1 -d\<`
	NEXT=""
	case $ENTITLEMENT in
		com.apple.developer.networking.vpn.api)
			NEXT=">>> VPN Configuration & Control"
			;;
		com.apple.developer.in-app-payments)
			NEXT=">>> Apple Pay (requires extra configuration)"
			;;
		com.apple.external-accessory.wireless-configuration)
			NEXT=">>> Wireless Accessory Configuration"
			;;
		com.apple.developer.homekit)
			NEXT=">>> HomeKit"
			;;
		com.apple.security.application-groups)
			NEXT=">>> App Groups:"
			for GROUP in `dd if="$ENTITLEMENTS" bs=1 skip=8 2>/dev/null | sed -ne '/application-groups/,/<\/array/p' | grep '<string>' 2>/dev/null`; do
				GROUP_ID=`echo $GROUP | cut -f2 -d\> | cut -f1 -d\<`-patched
				NEXT="$NEXT"$'\n'"    $GROUP_ID"
			done
			;;
		com.apple.developer.associated-domains)
			NEXT=">>> Associated Domains"
			;;
		com.apple.developer.healthkit)
			NEXT=">>> HealthKit"
			;;
		inter-app-audio)
			NEXT=">>> Inter-App Audio"
			;;
		com.apple.developer.ubiquity*)
			NEXT=">>> Passbook"
			NEXT=">>> iCloud (requires extra configuration)"
			NEXT=">>> Data Protection"
			;;
	esac
	[ -n "$NEXT" ] && ENT_LIST="$ENT_LIST"$'\n'"$NEXT"
done

eval "less <<EOF
$(<$INFO_TEMPLATE)" 2> /dev/null
